# 要件定義書

## 概要

この機能は、Zenless Zone Zero のボンプエンティティのメインアイコン画像を HoyoLab API から取得し、ローカルファイルシステムに保存するアイコンダウンロードシステムを作成します。システムは既存のボンプデータ生成パイプラインと統合し、各ボンプのメインアイコンのみを効率的にダウンロードして整理します。

## 要件

### 要件 1

**ユーザーストーリー:** 開発者として、ボンプのメインアイコン画像をローカルに保存したい。そうすることで、オフライン環境でもアプリケーションが画像を表示でき、外部 URL への依存を減らすことができる。

#### 受入基準

1. WHEN システムがボンプ API レスポンスを処理する時 THEN data.page.icon_url からメインアイコンをダウンロードする SHALL
2. WHEN 画像をダウンロードする時 THEN 適切なファイル名とディレクトリ構造で保存する SHALL
3. WHEN ダウンロードが失敗する時 THEN エラーをログに記録し、他のボンプの処理を継続する SHALL
4. WHEN 全 32 のボンプを処理する時 THEN 各ボンプのメインアイコンを個別にダウンロードする SHALL
5. WHEN API レスポンスに icon_url が存在しない時 THEN 警告をログに記録し、そのボンプをスキップする SHALL

### 要件 2

**ユーザーストーリー:** 開発者として、ダウンロードしたアイコン画像を整理された構造で保存したい。そうすることで、画像の管理と参照が容易になり、プロジェクトの保守性が向上する。

#### 受入基準

1. WHEN 画像を保存する時 THEN `assets/images/bomps/` ディレクトリ構造を使用する SHALL
2. WHEN メインアイコンを保存する時 THEN `{bompId}.png` 形式でファイル名を付ける SHALL
3. WHEN ファイル名に無効な文字が含まれる時 THEN 安全な文字に変換または除去する SHALL
4. WHEN 画像を保存する時 THEN PNG 形式で保存する SHALL
5. WHEN ディレクトリが存在しない時 THEN 自動的に作成する SHALL

### 要件 3

**ユーザーストーリー:** 開発者として、アイコンダウンロードのパフォーマンスと信頼性を確保したい。そうすることで、32 個のボンプアイコンを効率的に処理し、ネットワークエラーに対して堅牢なシステムを構築できる。

#### 受入基準

1. WHEN 複数のアイコンをダウンロードする時 THEN 並行処理を使用して効率を向上させる SHALL
2. WHEN ダウンロードが失敗する時 THEN 最大 3 回まで自動リトライを実行する SHALL
3. WHEN レート制限に遭遇する時 THEN 適切な遅延を実装してサーバー負荷を軽減する SHALL
4. WHEN 既存のアイコンファイルが存在する時 THEN ファイルサイズで重複チェックを行う SHALL
5. WHEN ダウンロード進捗を追跡する時 THEN 詳細なログとプログレス情報を提供する SHALL

### 要件 4

**ユーザーストーリー:** 開発者として、ダウンロードしたアイコンの整合性を確保したい。そうすることで、アイコンファイルが正しくダウンロードされ、適切に保存されることを保証できる。

#### 受入基準

1. WHEN アイコンダウンロードが完了する時 THEN ファイルサイズが 0 バイトでないことを確認する SHALL
2. WHEN アイコンを保存する時 THEN ファイルの書き込みが成功したことを確認する SHALL
3. WHEN ダウンロード処理を実行する時 THEN 成功・失敗の統計情報をログに出力する SHALL
4. WHEN 処理が完了する時 THEN ダウンロードされたアイコンの総数を報告する SHALL
5. WHEN エラーが発生する時 THEN 詳細なエラー情報をログに記録する SHALL

### 要件 5

**ユーザーストーリー:** 開発者として、アイコンダウンロードシステムを既存のプロジェクトアーキテクチャに統合したい。そうすることで、一貫性のあるコードベースを維持し、将来の拡張が容易になる。

#### 受入基準

1. WHEN システムを実装する時 THEN 既存のアーキテクチャレイヤー（clients → processors → generators）に従う SHALL
2. WHEN 設定を管理する時 THEN processing-config.json にアイコンダウンロード設定を追加する SHALL
3. WHEN エラーハンドリングを実装する時 THEN 既存のエラークラスとログシステムを使用する SHALL
4. WHEN 型定義を作成する時 THEN TypeScript の厳格な型安全性を維持する SHALL
5. WHEN 他のシステムと統合する時 THEN 既存のボンプデータ生成パイプラインと連携する SHALL
